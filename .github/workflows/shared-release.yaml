name: 🔖 Release (shared)

on:
  workflow_call:
    inputs:
      ref:
        description: The branch that is being released. Should be a branch on the given repository
        type: string
        default: main
      prerelease:
        description: Whether this is a prerelease
        type: boolean
        default: false
      pre-id:
        description: The pre-id to use for the prerelease
        type: string
        default: dev
jobs:
  release:
    runs-on: ubuntu-latest
    if: ${{ github.repository_owner == 'Happy-Times-Gaming' }}
    steps:
      - name: 📥 Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}
          fetch-depth: 0

      - name: 📦 Setup pnpm
        uses: pnpm/action-setup@v4

      - name: ⎔ Setup node
        uses: actions/setup-node@v4
        with:
          node-version-file: package.json
          cache: pnpm

      - name: 📥 Install deps
        run: pnpm install --frozen-lockfile

      - name: 🔏 Generate app token
        uses: actions/create-github-app-token@v1
        id: app-token
        with:
          app-id: ${{ secrets.RELEASER_APP_ID }}
          private-key: ${{ secrets.RELEASER_APP_KEY }}

      - name: ⚙️ Configure Git
        run: |
          # Get GitHub App User ID and set user-id output
          user_id=$(gh api "/users/${{ steps.app-token.outputs.app-slug }}[bot]" --jq .id)

          # Set the Git configuration
          # git remote set-url origin "https://${{ steps.app-token.outputs.token }}:x-oauth-basic@github.com/${{ github.repository }}.git"
          git config --global user.name "${{ steps.app-token.outputs.app-slug }}[bot]"
          git config --global user.email "${user_id}+${{ steps.app-token.outputs.app-slug }}[bot]@users.noreply.github.com"
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}

      - name: 🔖 Bump version & generate changelog
        run: |
          if [[ "${{ inputs.prerelease }}" = "false" ]]; then
            pnpm cliff-jumper -ghrl
          else
            pnpm cliff-jumper --preid ${{ inputs.pre-id }} -ghrpr
          fi
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
